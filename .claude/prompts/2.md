# Prompt 2: Database Schema for DID Storage

## Objective
Update Supabase schema to store DID Documents and link DIDs to user profiles.

## Prerequisites
- Load `supabase-operations` skill before starting
- Complete Prompt 1 (DID infrastructure)

## Tasks

### 2.1 Create DID Tables Migration

Create migration in `frontend/supabase/migrations/`:

```sql
-- DID Documents table
CREATE TABLE did_documents (
  did TEXT PRIMARY KEY,                    -- did:ethr:verychain:0x...
  controller TEXT NOT NULL,                -- Wallet address
  document JSONB NOT NULL,                 -- Full DID Document
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for fast lookups by controller
CREATE INDEX idx_did_controller ON did_documents(controller);

-- Update user_metadata to link to DID
ALTER TABLE user_metadata
ADD COLUMN did TEXT REFERENCES did_documents(did),
ADD COLUMN is_registered_onchain BOOLEAN DEFAULT FALSE,
ADD COLUMN onchain_registration_tx TEXT;
```

### 2.2 Create DID Repository (`frontend/lib/repositories/did-repository.ts`)

Implement:
- `saveDIDDocument(did: string, document: DIDDocument)` - Store DID Document
- `getDIDDocument(did: string)` - Retrieve DID Document
- `getDIDByAddress(address: Address)` - Get DID for wallet address
- `updateServiceEndpoints(did: string, services: ServiceEndpoint[])` - Update services
- `markOnchainRegistered(did: string, txHash: string)` - Mark as registered on-chain

### 2.3 Update User Metadata API

Update `/app/api/shinroe/user-metadata/route.ts`:
- Include DID in response when available
- Create DID automatically on first profile save if not exists
- Track on-chain registration status

### 2.4 Create DID Lookup API (`/app/api/shinroe/did/[did]/route.ts`)

Implement:
- GET: Resolve DID to DID Document
- Support both `did:ethr:verychain:0x...` and raw address lookups

## Acceptance Criteria
- [ ] DID Documents stored in Supabase
- [ ] User metadata linked to DIDs
- [ ] On-chain registration status tracked
- [ ] API endpoints working

## Files to Create/Update
- `frontend/supabase/migrations/YYYYMMDD_add_did_support.sql`
- `frontend/lib/repositories/did-repository.ts` (max 150 lines)
- `frontend/app/api/shinroe/did/[did]/route.ts` (max 100 lines)
- Update `frontend/app/api/shinroe/user-metadata/route.ts`
