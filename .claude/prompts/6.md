# Prompt 6: Migration Script & Testing

## Objective
Create migration script for existing users and comprehensive tests for the new DID system.

## Prerequisites
- Complete Prompts 1-5
- All contracts deployed
- Subgraph redeployed

## Tasks

### 6.1 Create Migration Script

Create `frontend/scripts/migrate-to-did.ts`:

```typescript
/**
 * Migration script to backfill DIDs for existing users
 *
 * For each existing on-chain registered user:
 * 1. Generate DID from address
 * 2. Create DID Document
 * 3. Store in Supabase
 * 4. Link to existing user_metadata
 * 5. Mark as on-chain registered
 */

async function migrateExistingUsers() {
  // 1. Query subgraph for all registered users
  const registeredUsers = await subgraphService.getAllRegisteredUsers()

  // 2. For each user, create DID and store
  for (const user of registeredUsers) {
    const did = didService.createDID(user.address)
    const didDocument = didService.generateDIDDocument(user.address)

    await didRepository.saveDIDDocument(did, didDocument)
    await didRepository.markOnchainRegistered(did, user.registrationTx)

    // Link to existing metadata if exists
    await userMetadataService.linkDID(user.address, did)
  }

  console.log(`Migrated ${registeredUsers.length} users to DID system`)
}
```

### 6.2 Create E2E Tests

Create `frontend/__tests__/e2e/did-registration.spec.ts`:

```typescript
describe('DID Registration Flow', () => {
  test('new user gets DID on wallet connect', async () => {
    // Connect wallet
    // Assert DID is created
    // Assert no on-chain registration yet
  })

  test('user can create profile without on-chain registration', async () => {
    // Connect wallet (DID created)
    // Create profile
    // Assert profile saved
    // Assert still not on-chain registered
  })

  test('on-chain registration triggers on first endorsement', async () => {
    // Setup: User A (registered), User B (DID only)
    // User B gives endorsement to User A
    // Assert User B is now on-chain registered
    // Assert endorsement is recorded
  })

  test('on-chain registration triggers on badge claim', async () => {
    // User with DID only
    // Claims verified identity badge
    // Assert auto-registered on-chain
    // Assert badge minted
  })

  test('existing on-chain users continue to work', async () => {
    // User already registered on-chain
    // Connect wallet
    // Assert DID resolves correctly
    // Assert all features work
  })
})
```

### 6.3 Create Integration Tests

Create `frontend/__tests__/integration/did-service.test.ts`:

- Test DID creation from various address formats
- Test DID Document generation
- Test JWT signing and verification
- Test resolver with VeryChain

### 6.4 Update Existing Tests

Update tests that assume on-chain registration:
- Remove mandatory registration steps where not needed
- Add DID-first flow tests
- Update mocks for new data structures

### 6.5 Create Rollback Script

Create `frontend/scripts/rollback-did-migration.ts`:

In case of issues, provide way to:
- Mark users as requiring re-registration
- Clean up DID tables if needed
- Revert to on-chain-first flow

## Acceptance Criteria
- [ ] Migration script works for existing users
- [ ] E2E tests cover all registration paths
- [ ] Integration tests for DID service
- [ ] Rollback script available
- [ ] All existing tests still pass

## Files to Create
- `frontend/scripts/migrate-to-did.ts`
- `frontend/scripts/rollback-did-migration.ts`
- `frontend/__tests__/e2e/did-registration.spec.ts`
- `frontend/__tests__/integration/did-service.test.ts`

## Deployment Order

1. Deploy updated contracts
2. Redeploy subgraph
3. Deploy frontend with DID support
4. Run migration script
5. Verify all users have DIDs
6. Monitor for issues
